#include <Wire.h> // Includerar Wire som behövs till I2C kommunication. Värme och fukt sensorn som vi använder kommunicerar med I2C
#include <AM2320.h> // Includerar bibloteket AM2320 som behövs för att värme och fukt sensorn ska fungera
#include "FirebaseESP8266.h" // Includerar ett biblotek som gör att ESP'n kan komunisera med FireBase
#include <ESP8266WiFi.h> // Includerar ett biblotek som gör att ESP'n ska kunna använda WiFi

#define FIREBASE_HOST "temperatur-1827b-default-rtdb.europe-west1.firebasedatabase.app" // Definerar var datan ska skickas
#define FIREBASE_AUTH "5Jh4mEGsGCHwdz8R3CMZVdYO7GsrP1Txg4pbhfpR" // Lösenord för att se att du är ägaren av FireBasen
#define WIFI_SSID "ABB_Indgym_Guest" // Namnet på wifiet som esp'n ska använda
#define WIFI_PASSWORD "Welcome2abb" // Lösenordet till WiFiet
//https://github.com/mobizt/Firebase-ESP8266

FirebaseData firebaseData1;  //Definerar Firebase Data objekt som innehåller många funktioner till firebase
AM2320 sensor; //Definerar sensor Data objekt som innehåller många funktioner som behövs för att hämta data från sensorn

const String rumPath = "/Terrariet"; // En konstant variabel som används för att veta vilket rum datan är skickad från. 
//Variabeln är olika för alla, vilket gör att vi lätt kan se var den skickade datan kommer från
const String tempPath = "/Temp"; // En konstatnt variabel som innehåller vägen temperaturen kommer skickas till i firebase
const String humPath = "/Hum"; // En konstatnt variabel som innehåller vägen luft fuktigheten kommer skickas till i firebase
const String currentPath = "/Current"; // Definerar en konstant string på vägen där den senaste uppdaterade datan kommer visas 
const String logPath = "/Log";  // Definerar en konstant variabel väg som kommer där all data kommer sparas
const String updatedPath = "/Updated";    // En konstant string som innehåller vägen där tidpunkten data skickats sparas

float SensorTemp; // Definerar en float som sparar den nuvarande temperaturen
float SensorHum; // Definerar en float som sparar den nuvarande luft fuktigheten

void setup() { // Denna funktion körs i början av programmet innan loopen 
  Serial.begin(115200); // Säger till arduinon i vilken hastighet komunikationen ska ske med serial monitorn
  Wire.begin(14,12); // Startar Wire som används för I2C komunikationen och säger vilka pins som ska användas för det

  WiFi.begin(WIFI_SSID, WIFI_PASSWORD); // Startar WiFi'et på ESP'n och skickar med wifiets namn och lösenord
    Serial.print("Connecting to Wi-Fi"); // printar i serial monitorn att arduinon försöker connecta med WiFi'et
    while (WiFi.status() != WL_CONNECTED) // en while loop som körs medans WiFi'et inte har connectat
    {
        Serial.print("."); // printar en . i serial monitorn varje 0,3 sekunder för att feedback att WiFi'et höller på att connecta
        delay(300);       //    ^
    }
    Serial.println();// printar en ny linje i serial monitorn
    Serial.print("Connected with IP: "); // Printar att WiFi'et har connectat
    Serial.println(WiFi.localIP()); // Skriver ut den locala IP adressen
    Serial.println(); // Skriver ut en ny linje

    Firebase.begin(FIREBASE_HOST, FIREBASE_AUTH); // Startar FireBase och skickar med var den ska skickas med HOST och AUTH för att veta att det är du som är ägare
    Firebase.reconnectWiFi(true); // Reconnnectar WiFi'et med Firebase (kolla om det är det den gör och skriv bättre!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!)

  delay(5000); // Väntar 5000 milisekunder eller 5 sekunder för att vara säker att fire base och wifi'et är kopplade innan vi börjar skicka information
}

void loop() { // En loop som körs om och om efter setup'en så länge arduinon har ström
  getTempHum();
  sendTempToFireBase();
  sendHumToFireBase();
  delay(30000);
}

void getTempHum(){
  if (sensor.measure()){
    SensorTemp = sensor.getTemperature();
    Serial.print("Temperture: ");
    Serial.println(SensorTemp);

    SensorHum = sensor.getHumidity();
    Serial.print("Humidity: ");
    Serial.println(SensorHum);
  }
  else{
    int errorCode = sensor.getErrorCode();
    switch (errorCode){
      case 1: Serial.println("ERR: Sensor is offline"); break;
      case 2: Serial.println("ERR: CRC validation failed."); break;
    }
  }
}

void sendTempToFireBase(){
  if (Firebase.setInt(firebaseData1, rumPath + tempPath + currentPath, SensorTemp))
  {
          Serial.println("Set " + currentPath + " to "+String(SensorTemp));
  }
  else
  {
      Serial.println("Could not set " + currentPath);
  }
  if (Firebase.pushInt(firebaseData1, rumPath + tempPath + logPath  , SensorTemp))
  {
      Serial.println("Temp logged");
  }
  else
  {
      Serial.println("Could not add temp to logger");
  }
        if (Firebase.pushTimestamp(firebaseData1, rumPath + tempPath + updatedPath ))
  {
      Serial.println("Time updated");
  }
  else
  {
      Serial.println("Could not set time");
  }
}

void sendHumToFireBase(){
  if (Firebase.setInt(firebaseData1, rumPath + humPath + currentPath, SensorHum))
  {
          Serial.println("Set " + currentPath + " to "+String(SensorHum));
  }
  else
  {
      Serial.println("Could not set " + currentPath);
  }
  if (Firebase.pushInt(firebaseData1, rumPath + humPath + logPath  , SensorHum))
  {
      Serial.println("Temp logged");
  }
  else
  {
      Serial.println("Could not add temp to logger");
  }
        if (Firebase.pushTimestamp(firebaseData1, rumPath + humPath + updatedPath ))
  {
      Serial.println("Time updated");
  }
  else
  {
      Serial.println("Could not set time");
  }
}